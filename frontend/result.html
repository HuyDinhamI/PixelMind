<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt qu·∫£ - PixelMind</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="result-screen">
            <div class="header">
                <h2>üéâ K·∫øt qu·∫£</h2>
                <p id="resultSummary"></p>
            </div>
            
            <div class="result-content">
                <!-- Before/After Comparison -->
                <div class="comparison-main">
                    <div class="comparison-container">
                        <div class="image-comparison">
                            <div class="before-after">
                                <div class="image-box">
                                    <h3>üì∏ ·∫¢nh g·ªëc</h3>
                                    <img id="originalImage" src="" alt="Original photo">
                                </div>
                                
                                <div class="arrow">‚Üí</div>
                                
                                <div class="image-box">
                                    <h3>‚ú® ·∫¢nh ƒë√£ ch·ªânh s·ª≠a</h3>
                                    <img id="generatedImage" src="" alt="Generated photo">
                                    <div class="image-overlay">
                                        <button class="download-btn" onclick="downloadImage()">
                                            ‚¨áÔ∏è T·∫£i xu·ªëng
                                        </button>
                                        <button class="qr-btn" onclick="showQRCode()" title="QR Code ƒë·ªÉ t·∫£i v·ªÅ ƒëi·ªán tho·∫°i">
                                            üì± QR Code
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Multiple Results Gallery (if available) -->
                <div class="generated-section" id="generatedSection" style="display: none;">
                    <h3>üé® L·ª±a ch·ªçn kh√°c</h3>
                    <div class="generated-gallery" id="generatedGallery">
                        <!-- Additional images will be loaded here -->
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="result-actions">
                    <button class="secondary-btn" onclick="startOver()">
                        üì∏ Ch·ª•p ·∫£nh m·ªõi
                    </button>
                    <button class="primary-btn" onclick="editAgain()">
                        ‚ú® Ch·ªânh s·ª≠a l·∫°i
                    </button>
                </div>
            </div>
            
            <!-- QR Code Modal -->
            <div id="qrModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üì± Qu√©t QR ƒë·ªÉ t·∫£i v·ªÅ ƒëi·ªán tho·∫°i</h3>
                        <button class="close-btn" onclick="closeQRModal()">√ó</button>
                    </div>
                    <div class="qr-container">
                        <img id="qrCodeImage" src="" alt="QR Code">
                        <p>Qu√©t m√£ QR n√†y ƒë·ªÉ t·∫£i ·∫£nh tr·ª±c ti·∫øp v·ªÅ ƒëi·ªán tho·∫°i</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        let currentResult = null;
        let selectedImageIndex = 0;
        
        // Load result when page loads
        window.addEventListener('load', function() {
            const resultData = localStorage.getItem('processResult');
            if (!resultData) {
                PixelMind.showNotification('Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£. Vui l√≤ng th·ª±c hi·ªán l·∫°i.', 'error');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                currentResult = JSON.parse(resultData);
                loadResult();
            } catch (error) {
                console.error('Error parsing result data:', error);
                PixelMind.showNotification('L·ªói d·ªØ li·ªáu k·∫øt qu·∫£. Vui l√≤ng th·ª±c hi·ªán l·∫°i.', 'error');
                window.location.href = 'index.html';
            }
        });
        
        function loadResult() {
            if (!currentResult) return;
            
            // Load original image from localStorage
            const capturedImageData = localStorage.getItem('capturedImage');
            if (capturedImageData) {
                document.getElementById('originalImage').src = capturedImageData;
            }
            
            // Show result summary
            const totalImages = currentResult.total_images || 1;
            document.getElementById('resultSummary').textContent = 
                `ƒê√£ t·∫°o th√†nh c√¥ng ${totalImages} ·∫£nh b·∫±ng AI`;
            
            // Load primary generated image
            const primaryImage = currentResult.primary_image || currentResult.generated_images[0];
            document.getElementById('generatedImage').src = `${PixelMind.API_BASE_URL}${primaryImage.url}`;
            
            // Show additional images if available
            if (currentResult.generated_images && currentResult.generated_images.length > 1) {
                loadAdditionalImages();
            }
        }
        
        function loadAdditionalImages() {
            document.getElementById('generatedSection').style.display = 'block';
            
            const gallery = document.getElementById('generatedGallery');
            const images = currentResult.generated_images;
            
            gallery.innerHTML = images.map((image, index) => `
                <div class="generated-item ${index === 0 ? 'selected' : ''}" onclick="selectImage(${index})">
                    <img src="${PixelMind.API_BASE_URL}${image.url}" alt="L·ª±a ch·ªçn ${index + 1}">
                    <div class="image-number">${index + 1}</div>
                </div>
            `).join('');
        }
        
        function selectImage(index) {
            // Update selection in gallery
            const items = document.querySelectorAll('.generated-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // Update main display
            selectedImageIndex = index;
            const selectedImage = currentResult.generated_images[index];
            document.getElementById('generatedImage').src = `${PixelMind.API_BASE_URL}${selectedImage.url}`;
        }
        
        function downloadImage() {
            if (!currentResult) return;
            
            const images = currentResult.generated_images || [currentResult.primary_image];
            const selectedImage = images[selectedImageIndex];
            
            const downloadUrl = `${PixelMind.API_BASE_URL}/api/download/${selectedImage.filename}`;
            
            // Create temporary link for download
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `pixelmind_edited.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            PixelMind.showNotification('ƒêang t·∫£i ·∫£nh...', 'success');
        }
        
        function showQRCode() {
            if (!currentResult) return;
            
            const images = currentResult.generated_images || [currentResult.primary_image];
            const selectedImage = images[selectedImageIndex];
            
            const qrUrl = `${PixelMind.API_BASE_URL}/api/qr/${selectedImage.filename}`;
            document.getElementById('qrCodeImage').src = qrUrl;
            document.getElementById('qrModal').style.display = 'flex';
        }
        
        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }
        
        function startOver() {
            // Clear all stored data
            PixelMind.clearAllData();
            
            // Go back to start
            window.location.href = 'index.html';
        }
        
        function editAgain() {
            // Keep the captured image, just go back to edit
            window.location.href = 'edit.html';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('qrModal');
            if (event.target === modal) {
                closeQRModal();
            }
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            const images = currentResult?.generated_images || [currentResult?.primary_image];
            if (!images) return;
            
            if (e.key === 'ArrowLeft' && selectedImageIndex > 0) {
                selectImage(selectedImageIndex - 1);
            } else if (e.key === 'ArrowRight' && selectedImageIndex < images.length - 1) {
                selectImage(selectedImageIndex + 1);
            } else if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                downloadImage();
            } else if (e.key === 'Escape') {
                closeQRModal();
            }
        });
    </script>
</body>
</html>
