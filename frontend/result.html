<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt qu·∫£ - PixelMind</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="result-screen">
            <div class="header">
                <h2>üéâ K·∫øt qu·∫£</h2>
                <p id="resultSummary"></p>
            </div>
            
            <div class="result-content">
                <!-- Original Image -->
                <div class="original-section">
                    <h3>üì∏ ·∫¢nh g·ªëc</h3>
                    <div class="original-container">
                        <img id="originalImage" src="" alt="Original photo">
                    </div>
                </div>
                
                <!-- Generated Images Gallery -->
                <div class="generated-section">
                    <h3>‚ú® ·∫¢nh ƒë√£ t·∫°o</h3>
                    <div class="generated-gallery" id="generatedGallery">
                        <!-- Images will be loaded here -->
                    </div>
                </div>
                
                <!-- Selected Image for Comparison -->
                <div class="comparison-section" id="comparisonSection" style="display: none;">
                    <h3>üîç So s√°nh chi ti·∫øt</h3>
                    <div class="comparison-container">
                        <div class="image-comparison">
                            <div class="before-after">
                                <div class="image-box">
                                    <h4>·∫¢nh g·ªëc</h4>
                                    <img id="compareOriginal" src="" alt="Original photo">
                                </div>
                                
                                <div class="arrow">‚Üí</div>
                                
                                <div class="image-box">
                                    <h4>·∫¢nh ƒë√£ ch·ªânh s·ª≠a</h4>
                                    <img id="compareGenerated" src="" alt="Generated photo">
                                    <div class="image-overlay">
                                        <button class="download-btn" onclick="downloadSelectedImage()">
                                            ‚¨áÔ∏è T·∫£i xu·ªëng
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Result Information -->
                <div class="result-info">
                    <div class="prompt-section">
                        <h4>üìù Th√¥ng tin x·ª≠ l√Ω:</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <strong>M√¥ t·∫£ g·ªëc:</strong>
                                <p id="originalPrompt"></p>
                            </div>
                            <div class="info-item" id="enhancedPromptSection" style="display: none;">
                                <strong>M√¥ t·∫£ ƒë√£ t·ªëi ∆∞u:</strong>
                                <p id="enhancedPrompt"></p>
                            </div>
                            <div class="info-item">
                                <strong>C√†i ƒë·∫∑t s·ª≠ d·ª•ng:</strong>
                                <div id="settingsInfo"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-actions">
                        <button class="secondary-btn" onclick="startOver()">
                            üì∏ Ch·ª•p ·∫£nh m·ªõi
                        </button>
                        <button class="primary-btn" onclick="editAgain()">
                            ‚ú® Ch·ªânh s·ª≠a l·∫°i
                        </button>
                        <button class="tertiary-btn" onclick="downloadAll()" id="downloadAllBtn" style="display: none;">
                            üì¶ T·∫£i t·∫•t c·∫£
                        </button>
                    </div>
                </div>
                
                <div class="tips">
                    <h4>üí° M·∫πo s·ª≠ d·ª•ng:</h4>
                    <ul>
                        <li><strong>PhotoReal v2:</strong> Model t·ªëi ∆∞u cho ·∫£nh th·ª±c t·∫ø, gi·ªØ nguy√™n chi ti·∫øt g·ªëc</li>
                        <li><strong>M·ª©c ƒë·ªô thay ƒë·ªïi th·∫•p:</strong> Gi√∫p ·∫£nh sinh ra g·∫ßn v·ªõi b·∫£n g·ªëc h∆°n</li>
                        <li><strong>Nhi·ªÅu l·ª±a ch·ªçn:</strong> T·∫°o nhi·ªÅu ·∫£nh ƒë·ªÉ ch·ªçn ra k·∫øt qu·∫£ t·ªët nh·∫•t</li>
                        <li><strong>Prompt engineering:</strong> H·ªá th·ªëng t·ª± ƒë·ªông t·ªëi ∆∞u m√¥ t·∫£ c·ªßa b·∫°n</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        let currentResult = null;
        let selectedImageIndex = 0;
        
        // Load result when page loads
        window.addEventListener('load', function() {
            const resultData = localStorage.getItem('processResult');
            if (!resultData) {
                PixelMind.showNotification('Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£. Vui l√≤ng th·ª±c hi·ªán l·∫°i.', 'error');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                currentResult = JSON.parse(resultData);
                loadResult();
            } catch (error) {
                console.error('Error parsing result data:', error);
                PixelMind.showNotification('L·ªói d·ªØ li·ªáu k·∫øt qu·∫£. Vui l√≤ng th·ª±c hi·ªán l·∫°i.', 'error');
                window.location.href = 'index.html';
            }
        });
        
        function loadResult() {
            if (!currentResult) return;
            
            // Load original image from localStorage
            const capturedImageData = localStorage.getItem('capturedImage');
            if (capturedImageData) {
                document.getElementById('originalImage').src = capturedImageData;
                document.getElementById('compareOriginal').src = capturedImageData;
            }
            
            // Show result summary
            const totalImages = currentResult.total_images || 1;
            document.getElementById('resultSummary').textContent = 
                `ƒê√£ t·∫°o th√†nh c√¥ng ${totalImages} ·∫£nh v·ªõi PhotoReal v2`;
            
            // Load generated images gallery
            loadGeneratedGallery();
            
            // Load result information
            loadResultInfo();
            
            // Show download all button if multiple images
            if (totalImages > 1) {
                document.getElementById('downloadAllBtn').style.display = 'inline-block';
            }
        }
        
        function loadGeneratedGallery() {
            const gallery = document.getElementById('generatedGallery');
            const images = currentResult.generated_images || [currentResult.primary_image];
            
            gallery.innerHTML = images.map((image, index) => `
                <div class="generated-item ${index === 0 ? 'selected' : ''}" onclick="selectImage(${index})">
                    <img src="${PixelMind.API_BASE_URL}${image.url}" alt="Generated ${index + 1}">
                    <div class="image-number">${index + 1}</div>
                    <div class="selection-indicator">
                        <span class="checkmark">‚úì</span>
                    </div>
                </div>
            `).join('');
            
            // Auto-select first image
            selectImage(0);
        }
        
        function selectImage(index) {
            // Update selection in gallery
            const items = document.querySelectorAll('.generated-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // Update comparison view
            selectedImageIndex = index;
            const images = currentResult.generated_images || [currentResult.primary_image];
            const selectedImage = images[index];
            
            document.getElementById('compareGenerated').src = `${PixelMind.API_BASE_URL}${selectedImage.url}`;
            
            // Show comparison section
            document.getElementById('comparisonSection').style.display = 'block';
            
            // Scroll to comparison
            document.getElementById('comparisonSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
        
        function loadResultInfo() {
            // Original prompt
            const originalPrompt = localStorage.getItem('lastPrompt') || 'Kh√¥ng c√≥ th√¥ng tin';
            document.getElementById('originalPrompt').textContent = originalPrompt;
            
            // Enhanced prompt (if available)
            if (currentResult.enhanced_prompt && currentResult.enhanced_prompt !== originalPrompt) {
                document.getElementById('enhancedPrompt').textContent = currentResult.enhanced_prompt;
                document.getElementById('enhancedPromptSection').style.display = 'block';
            }
            
            // Settings info
            const settings = currentResult.settings || {};
            const settingsHTML = `
                <div class="settings-display">
                    <span><strong>Model:</strong> ${settings.model || 'PhotoReal v2'}</span>
                    <span><strong>M·ª©c ƒë·ªô thay ƒë·ªïi:</strong> ${Math.round((settings.strength || 0.3) * 100)}%</span>
                    <span><strong>Guidance Scale:</strong> ${settings.guidance_scale || 7}</span>
                </div>
            `;
            document.getElementById('settingsInfo').innerHTML = settingsHTML;
        }
        
        function downloadSelectedImage() {
            if (!currentResult) return;
            
            const images = currentResult.generated_images || [currentResult.primary_image];
            const selectedImage = images[selectedImageIndex];
            
            const downloadUrl = `${PixelMind.API_BASE_URL}/api/download/${selectedImage.filename}`;
            
            // Create temporary link for download
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `pixelmind_edited_${selectedImageIndex + 1}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            PixelMind.showNotification('ƒêang t·∫£i ·∫£nh...', 'success');
        }
        
        function downloadAll() {
            if (!currentResult) return;
            
            const images = currentResult.generated_images || [currentResult.primary_image];
            
            PixelMind.showNotification(`ƒêang t·∫£i ${images.length} ·∫£nh...`, 'info');
            
            images.forEach((image, index) => {
                setTimeout(() => {
                    const downloadUrl = `${PixelMind.API_BASE_URL}/api/download/${image.filename}`;
                    
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = `pixelmind_edited_${index + 1}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, index * 1000); // Stagger downloads by 1 second
            });
        }
        
        function startOver() {
            // Clear all stored data
            PixelMind.clearAllData();
            
            // Go back to start
            window.location.href = 'index.html';
        }
        
        function editAgain() {
            // Keep the captured image, just go back to edit
            window.location.href = 'edit.html';
        }
        
        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            const images = currentResult?.generated_images || [currentResult?.primary_image];
            if (!images) return;
            
            if (e.key === 'ArrowLeft' && selectedImageIndex > 0) {
                selectImage(selectedImageIndex - 1);
            } else if (e.key === 'ArrowRight' && selectedImageIndex < images.length - 1) {
                selectImage(selectedImageIndex + 1);
            } else if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                downloadSelectedImage();
            }
        });
    </script>
</body>
</html>
