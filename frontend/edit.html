<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªânh s·ª≠a - PixelMind</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="edit-screen">
            <div class="header">
                <button class="back-btn" onclick="goBack()">‚Üê Quay l·∫°i</button>
                <h2>‚ú® Ch·ªânh s·ª≠a ·∫£nh</h2>
            </div>
            
            <div class="edit-content">
                <div class="image-preview">
                    <h3>·∫¢nh v·ª´a ch·ª•p:</h3>
                    <img id="capturedImage" src="" alt="Captured photo">
                </div>
                
                <div class="prompt-section">
                    <h3>M√¥ t·∫£ c√°ch b·∫°n mu·ªën ch·ªânh s·ª≠a ·∫£nh:</h3>
                    <textarea 
                        id="promptInput" 
                        placeholder="V√≠ d·ª•: Th√™m m·ªôt chi·∫øc m≈© h·ªìng cho ch√∫ ch√≥, thay ƒë·ªïi m√†u √°o th√†nh xanh d∆∞∆°ng, th√™m k√≠nh m√°t..."
                        rows="4"
                    ></textarea>
                    
                    <div class="prompt-examples">
                        <h4>G·ª£i √Ω:</h4>
                        <div class="example-tags">
                            <span class="tag" onclick="addExample('Th√™m m·ªôt chi·∫øc m≈© ƒë·ªè')">Th√™m m≈© ƒë·ªè</span>
                            <span class="tag" onclick="addExample('Thay ƒë·ªïi m√†u √°o th√†nh xanh d∆∞∆°ng')">ƒê·ªïi m√†u √°o</span>
                            <span class="tag" onclick="addExample('Th√™m k√≠nh m√°t th·ªùi trang')">Th√™m k√≠nh m√°t</span>
                            <span class="tag" onclick="addExample('Th√™m n·ªÅn c·∫£nh b√£i bi·ªÉn')">ƒê·ªïi n·ªÅn bi·ªÉn</span>
                            <span class="tag" onclick="addExample('L√†m cho ·∫£nh tr√¥ng ngh·ªá thu·∫≠t h∆°n')">Phong c√°ch ngh·ªá thu·∫≠t</span>
                        </div>
                    </div>
                </div>
                
                <button id="processBtn" class="process-btn" onclick="processImage()">
                    üöÄ T·∫°o ·∫£nh m·ªõi
                </button>
            </div>
            
            <!-- Loading modal -->
            <div id="loadingModal" class="modal" style="display: none;">
                <div class="modal-content loading-content">
                    <div class="loading-spinner"></div>
                    <h3>ƒêang x·ª≠ l√Ω ·∫£nh...</h3>
                    <p>AI ƒëang t·∫°o ra phi√™n b·∫£n m·ªõi c·ªßa ·∫£nh theo y√™u c·∫ßu c·ªßa b·∫°n. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t 20-30 gi√¢y.</p>
                    <div class="loading-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <span id="progressText">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        // Load captured image when page loads
        window.addEventListener('load', function() {
            const capturedImageData = localStorage.getItem('capturedImage');
            if (!capturedImageData) {
                alert('Kh√¥ng t√¨m th·∫•y ·∫£nh. Vui l√≤ng ch·ª•p ·∫£nh l·∫°i.');
                window.location.href = 'camera.html';
                return;
            }
            
            document.getElementById('capturedImage').src = capturedImageData;
        });
        
        function addExample(text) {
            const promptInput = document.getElementById('promptInput');
            const currentText = promptInput.value.trim();
            
            if (currentText === '') {
                promptInput.value = text;
            } else {
                promptInput.value = currentText + ', ' + text;
            }
            
            promptInput.focus();
        }
        
        function goBack() {
            window.location.href = 'camera.html';
        }
        
        async function processImage() {
            const prompt = document.getElementById('promptInput').value.trim();
            
            if (!prompt) {
                alert('Vui l√≤ng nh·∫≠p m√¥ t·∫£ c√°ch b·∫°n mu·ªën ch·ªânh s·ª≠a ·∫£nh.');
                return;
            }
            
            const capturedImageData = localStorage.getItem('capturedImage');
            if (!capturedImageData) {
                alert('Kh√¥ng t√¨m th·∫•y ·∫£nh. Vui l√≤ng ch·ª•p ·∫£nh l·∫°i.');
                return;
            }
            
            // Save prompt for later use
            localStorage.setItem('lastPrompt', prompt);
            
            // Show loading modal
            showLoading();
            
            try {
                // Convert base64 to blob
                const response = await fetch(capturedImageData);
                const blob = await response.blob();
                
                // Create form data
                const formData = new FormData();
                formData.append('image', blob, 'captured.jpg');
                formData.append('prompt', prompt);
                
                // Send to backend
                const result = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await result.json();
                
                hideLoading();
                
                if (data.success) {
                    // Store result data and go to result page
                    localStorage.setItem('processResult', JSON.stringify(data));
                    window.location.href = 'result.html';
                } else {
                    alert('L·ªói x·ª≠ l√Ω ·∫£nh: ' + data.error);
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error processing image:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
        
        function showLoading() {
            document.getElementById('loadingModal').style.display = 'flex';
            
            // Simulate progress
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const interval = setInterval(() => {
                progress += Math.random() * 5;
                if (progress > 95) progress = 95;
                
                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
            }, 1000);
            
            // Store interval to clear later
            window.loadingInterval = interval;
        }
        
        function hideLoading() {
            document.getElementById('loadingModal').style.display = 'none';
            if (window.loadingInterval) {
                clearInterval(window.loadingInterval);
            }
        }
    </script>
</body>
</html>
