<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªânh s·ª≠a - PixelMind</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="edit-screen">
            <div class="header">
                <button class="back-btn" onclick="goBack()">‚Üê Quay l·∫°i</button>
                <h2>‚ú® Ch·ªânh s·ª≠a ·∫£nh</h2>
            </div>
            
            <div class="edit-content">
                <div class="image-preview">
                    <h3>·∫¢nh v·ª´a ch·ª•p:</h3>
                    <img id="capturedImage" src="" alt="Captured photo">
                </div>
                
                <div class="prompt-section">
                    <h3>M√¥ t·∫£ c√°ch b·∫°n mu·ªën ch·ªânh s·ª≠a ·∫£nh:</h3>
                    <textarea 
                        id="promptInput" 
                        placeholder="V√≠ d·ª•: th√™m √°nh s√°ng ·∫•m √°p, l√†m s√°ng v√† r√µ n√©t h∆°n, thay ƒë·ªïi th√†nh phong c√°ch vintage..."
                        rows="4"
                    ></textarea>
                    
                    <div class="prompt-examples">
                        <h4>G·ª£i √Ω:</h4>
                        <div class="example-tags" id="exampleTags">
                            <!-- Will be loaded from API -->
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Settings -->
                <div class="settings-section">
                    <div class="settings-header" onclick="toggleSettings()">
                        <h4>‚öôÔ∏è C√†i ƒë·∫∑t n√¢ng cao</h4>
                        <span id="settingsToggle">‚ñº</span>
                    </div>
                    
                    <div id="advancedSettings" class="settings-content">
                        <div class="setting-item">
                            <label for="strengthSlider">M·ª©c ƒë·ªô thay ƒë·ªïi:</label>
                            <div class="slider-container">
                                <input type="range" id="strengthSlider" min="0.1" max="0.8" step="0.1" value="0.3">
                                <span id="strengthValue">30%</span>
                            </div>
                            <p class="setting-description">M·ª©c ƒë·ªô thay ƒë·ªïi so v·ªõi ·∫£nh g·ªëc (th·∫•p = √≠t thay ƒë·ªïi)</p>
                        </div>
                        
                        <div class="setting-item">
                            <label for="guidanceSlider">M·ª©c ƒë·ªô tu√¢n theo m√¥ t·∫£:</label>
                            <div class="slider-container">
                                <input type="range" id="guidanceSlider" min="3" max="15" step="1" value="7">
                                <span id="guidanceValue">7</span>
                            </div>
                            <p class="setting-description">M·ª©c ƒë·ªô AI tu√¢n theo m√¥ t·∫£ c·ªßa b·∫°n</p>
                        </div>
                        
                        <div class="setting-item">
                            <label for="numImagesSlider">S·ªë l∆∞·ª£ng ·∫£nh t·∫°o:</label>
                            <div class="slider-container">
                                <input type="range" id="numImagesSlider" min="1" max="4" step="1" value="2">
                                <span id="numImagesValue">2</span>
                            </div>
                            <p class="setting-description">S·ªë l∆∞·ª£ng ·∫£nh ƒë∆∞·ª£c t·∫°o ƒë·ªÉ l·ª±a ch·ªçn</p>
                        </div>
                        
                        <div class="model-info">
                            <p><strong>Model:</strong> PhotoReal v2 (T·ªëi ∆∞u cho ·∫£nh th·ª±c t·∫ø)</p>
                        </div>
                    </div>
                </div>
                
                <button id="processBtn" class="process-btn" onclick="processImage()">
                    üöÄ T·∫°o ·∫£nh m·ªõi
                </button>
            </div>
            
            <!-- Loading modal -->
            <div id="loadingModal" class="modal" style="display: none;">
                <div class="modal-content loading-content">
                    <div class="loading-spinner"></div>
                    <h3>ƒêang x·ª≠ l√Ω ·∫£nh...</h3>
                    <p id="loadingDescription">AI ƒëang t·∫°o ra phi√™n b·∫£n m·ªõi c·ªßa ·∫£nh theo y√™u c·∫ßu c·ªßa b·∫°n. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t 25-30 gi√¢y.</p>
                    <div class="loading-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="loading-info">
                        <p>‚ú® S·ª≠ d·ª•ng PhotoReal v2 cho ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t</p>
                        <p id="enhancedPromptDisplay"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        let apiSettings = {};
        
        // Load captured image and settings when page loads
        window.addEventListener('load', async function() {
            const capturedImageData = localStorage.getItem('capturedImage');
            if (!capturedImageData) {
                PixelMind.showNotification('Kh√¥ng t√¨m th·∫•y ·∫£nh. Vui l√≤ng ch·ª•p ·∫£nh l·∫°i.', 'error');
                window.location.href = 'camera.html';
                return;
            }
            
            document.getElementById('capturedImage').src = capturedImageData;
            
            // Load settings from API
            await loadAPISettings();
            
            // Setup slider listeners
            setupSliderListeners();
            
            // Load saved prompt if any
            const savedPrompt = PixelMind.getSavedPrompt();
            if (savedPrompt) {
                document.getElementById('promptInput').value = savedPrompt;
            }
        });
        
        async function loadAPISettings() {
            try {
                const response = await fetch(`${PixelMind.API_BASE_URL}/api/settings`);
                apiSettings = await response.json();
                
                // Load prompt suggestions
                loadPromptSuggestions();
                
            } catch (error) {
                console.error('Error loading settings:', error);
                // Fallback suggestions
                loadFallbackSuggestions();
            }
        }
        
        function loadPromptSuggestions() {
            const container = document.getElementById('exampleTags');
            const suggestions = apiSettings.prompt_suggestions || [
                'th√™m √°nh s√°ng ·∫•m √°p',
                'l√†m s√°ng v√† r√µ n√©t h∆°n',
                'thay ƒë·ªïi th√†nh phong c√°ch vintage'
            ];
            
            container.innerHTML = suggestions.map(suggestion => 
                `<span class="tag" onclick="addExample('${suggestion}')">${suggestion}</span>`
            ).join('');
        }
        
        function loadFallbackSuggestions() {
            const container = document.getElementById('exampleTags');
            const fallback = [
                'th√™m √°nh s√°ng ·∫•m √°p',
                'l√†m s√°ng v√† r√µ n√©t h∆°n',
                'thay ƒë·ªïi th√†nh phong c√°ch vintage',
                'l√†m ·∫£nh tr·ªü n√™n ngh·ªá thu·∫≠t h∆°n',
                'c·∫£i thi·ªán ch·∫•t l∆∞·ª£ng ·∫£nh'
            ];
            
            container.innerHTML = fallback.map(suggestion => 
                `<span class="tag" onclick="addExample('${suggestion}')">${suggestion}</span>`
            ).join('');
        }
        
        function setupSliderListeners() {
            // Strength slider
            const strengthSlider = document.getElementById('strengthSlider');
            const strengthValue = document.getElementById('strengthValue');
            strengthSlider.addEventListener('input', function() {
                strengthValue.textContent = Math.round(this.value * 100) + '%';
            });
            
            // Guidance slider
            const guidanceSlider = document.getElementById('guidanceSlider');
            const guidanceValue = document.getElementById('guidanceValue');
            guidanceSlider.addEventListener('input', function() {
                guidanceValue.textContent = this.value;
            });
            
            // Num images slider
            const numImagesSlider = document.getElementById('numImagesSlider');
            const numImagesValue = document.getElementById('numImagesValue');
            numImagesSlider.addEventListener('input', function() {
                numImagesValue.textContent = this.value;
            });
        }
        
        function toggleSettings() {
            const settings = document.getElementById('advancedSettings');
            const toggle = document.getElementById('settingsToggle');
            
            if (settings.style.display === 'none' || settings.style.display === '') {
                settings.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                settings.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }
        
        function addExample(text) {
            const promptInput = document.getElementById('promptInput');
            const currentText = promptInput.value.trim();
            
            if (currentText === '') {
                promptInput.value = text;
            } else {
                promptInput.value = currentText + ', ' + text;
            }
            
            promptInput.focus();
        }
        
        function goBack() {
            window.location.href = 'camera.html';
        }
        
        async function processImage() {
            const prompt = document.getElementById('promptInput').value.trim();
            
            if (!prompt) {
                PixelMind.showNotification('Vui l√≤ng nh·∫≠p m√¥ t·∫£ c√°ch b·∫°n mu·ªën ch·ªânh s·ª≠a ·∫£nh.', 'error');
                return;
            }
            
            const capturedImageData = localStorage.getItem('capturedImage');
            if (!capturedImageData) {
                PixelMind.showNotification('Kh√¥ng t√¨m th·∫•y ·∫£nh. Vui l√≤ng ch·ª•p ·∫£nh l·∫°i.', 'error');
                return;
            }
            
            // Save prompt for later use
            PixelMind.savePrompt(prompt);
            
            // Get settings values
            const strength = document.getElementById('strengthSlider').value;
            const guidanceScale = document.getElementById('guidanceSlider').value;
            const numImages = document.getElementById('numImagesSlider').value;
            
            // Show loading modal
            showLoading(prompt, {strength, guidanceScale, numImages});
            
            try {
                // Convert base64 to blob
                const response = await fetch(capturedImageData);
                const blob = await response.blob();
                
                // Create form data v·ªõi custom settings
                const formData = new FormData();
                formData.append('image', blob, 'captured.jpg');
                formData.append('prompt', prompt);
                formData.append('strength', strength);
                formData.append('guidance_scale', guidanceScale);
                formData.append('num_images', numImages);
                
                // Send to backend (s·ª≠ d·ª•ng custom endpoint)
                const result = await fetch(`${PixelMind.API_BASE_URL}/api/upload_custom`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await result.json();
                
                hideLoading();
                
                if (data.success) {
                    // Store result data and go to result page
                    localStorage.setItem('processResult', JSON.stringify(data));
                    PixelMind.showNotification(`T·∫°o th√†nh c√¥ng ${data.total_images} ·∫£nh!`, 'success');
                    setTimeout(() => {
                        window.location.href = 'result.html';
                    }, 1000);
                } else {
                    PixelMind.showNotification('L·ªói x·ª≠ l√Ω ·∫£nh: ' + data.error, 'error');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error processing image:', error);
                PixelMind.showNotification('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        }
        
        function showLoading(prompt, settings) {
            document.getElementById('loadingModal').style.display = 'flex';
            
            // Update loading description
            const numImages = settings.numImages;
            const description = `AI ƒëang t·∫°o ${numImages} ·∫£nh v·ªõi m·ª©c ƒë·ªô thay ƒë·ªïi ${Math.round(settings.strength * 100)}%. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t 25-35 gi√¢y.`;
            document.getElementById('loadingDescription').textContent = description;
            
            // Show enhanced prompt info
            const enhancedInfo = document.getElementById('enhancedPromptDisplay');
            enhancedInfo.innerHTML = `<strong>M√¥ t·∫£ g·ªëc:</strong> "${prompt}"`;
            
            // Simulate progress
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const interval = setInterval(() => {
                progress += Math.random() * 3 + 1;
                if (progress > 95) progress = 95;
                
                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
            }, 1000);
            
            // Store interval to clear later
            window.loadingInterval = interval;
        }
        
        function hideLoading() {
            document.getElementById('loadingModal').style.display = 'none';
            if (window.loadingInterval) {
                clearInterval(window.loadingInterval);
            }
        }
    </script>
</body>
</html>
