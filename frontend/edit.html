<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªânh s·ª≠a - PixelMind</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="edit-screen">
            <div class="header">
                <button class="back-btn" onclick="goBack()">‚Üê Quay l·∫°i</button>
                <h2>‚ú® Ch·ªânh s·ª≠a ·∫£nh</h2>
            </div>
            
            <div class="edit-content">
                <div class="image-preview">
                    <h3>·∫¢nh v·ª´a ch·ª•p:</h3>
                    <img id="capturedImage" src="" alt="Captured photo">
                </div>
                
                <div class="prompt-section">
                    <h3>M√¥ t·∫£ c√°ch b·∫°n mu·ªën ch·ªânh s·ª≠a ·∫£nh:</h3>
                    <textarea 
                        id="promptInput" 
                        placeholder="V√≠ d·ª•: th√™m √°nh s√°ng ·∫•m √°p, l√†m s√°ng v√† r√µ n√©t h∆°n, thay ƒë·ªïi th√†nh phong c√°ch vintage..."
                        rows="4"
                    ></textarea>
                    
                    <div class="prompt-examples">
                        <h4>G·ª£i √Ω:</h4>
                        <div class="example-tags" id="exampleTags">
                            <span class="tag" onclick="addExample('th√™m √°nh s√°ng ·∫•m √°p')">th√™m √°nh s√°ng ·∫•m √°p</span>
                            <span class="tag" onclick="addExample('l√†m s√°ng v√† r√µ n√©t h∆°n')">l√†m s√°ng v√† r√µ n√©t h∆°n</span>
                            <span class="tag" onclick="addExample('thay ƒë·ªïi th√†nh phong c√°ch vintage')">thay ƒë·ªïi th√†nh phong c√°ch vintage</span>
                            <span class="tag" onclick="addExample('l√†m ·∫£nh tr·ªü n√™n ngh·ªá thu·∫≠t h∆°n')">l√†m ·∫£nh tr·ªü n√™n ngh·ªá thu·∫≠t h∆°n</span>
                            <span class="tag" onclick="addExample('c·∫£i thi·ªán ch·∫•t l∆∞·ª£ng ·∫£nh')">c·∫£i thi·ªán ch·∫•t l∆∞·ª£ng ·∫£nh</span>
                            <span class="tag" onclick="addExample('th√™m hi·ªáu ·ª©ng bokeh')">th√™m hi·ªáu ·ª©ng bokeh</span>
                        </div>
                    </div>
                </div>
                
                <div class="model-info">
                    <p><strong>‚ú® S·ª≠ d·ª•ng PhotoReal v2</strong> - Model AI t·ªëi ∆∞u cho ·∫£nh th·ª±c t·∫ø, gi·ªØ nguy√™n chi ti·∫øt g·ªëc v√† ch·∫•t l∆∞·ª£ng cao</p>
                </div>
                
                <button id="processBtn" class="process-btn" onclick="processImage()">
                    üöÄ T·∫°o ·∫£nh m·ªõi
                </button>
            </div>
            
            <!-- Loading modal -->
            <div id="loadingModal" class="modal" style="display: none;">
                <div class="modal-content loading-content">
                    <div class="loading-spinner"></div>
                    <h3>ƒêang x·ª≠ l√Ω ·∫£nh...</h3>
                    <p id="loadingDescription">AI ƒëang t·∫°o ra 2 phi√™n b·∫£n m·ªõi c·ªßa ·∫£nh theo y√™u c·∫ßu c·ªßa b·∫°n. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t 25-30 gi√¢y.</p>
                    <div class="loading-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="loading-info">
                        <p>‚ú® S·ª≠ d·ª•ng PhotoReal v2 cho ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t</p>
                        <p id="enhancedPromptDisplay"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        // Load captured image when page loads
        window.addEventListener('load', function() {
            const capturedImageData = localStorage.getItem('capturedImage');
            if (!capturedImageData) {
                PixelMind.showNotification('Kh√¥ng t√¨m th·∫•y ·∫£nh. Vui l√≤ng ch·ª•p ·∫£nh l·∫°i.', 'error');
                window.location.href = 'camera.html';
                return;
            }
            
            document.getElementById('capturedImage').src = capturedImageData;
            
            // Load saved prompt if any
            const savedPrompt = PixelMind.getSavedPrompt();
            if (savedPrompt) {
                document.getElementById('promptInput').value = savedPrompt;
            }
        });
        
        function addExample(text) {
            const promptInput = document.getElementById('promptInput');
            const currentText = promptInput.value.trim();
            
            if (currentText === '') {
                promptInput.value = text;
            } else {
                promptInput.value = currentText + ', ' + text;
            }
            
            promptInput.focus();
        }
        
        function goBack() {
            window.location.href = 'camera.html';
        }
        
        async function processImage() {
            const prompt = document.getElementById('promptInput').value.trim();
            
            if (!prompt) {
                PixelMind.showNotification('Vui l√≤ng nh·∫≠p m√¥ t·∫£ c√°ch b·∫°n mu·ªën ch·ªânh s·ª≠a ·∫£nh.', 'error');
                return;
            }
            
            const capturedImageData = localStorage.getItem('capturedImage');
            if (!capturedImageData) {
                PixelMind.showNotification('Kh√¥ng t√¨m th·∫•y ·∫£nh. Vui l√≤ng ch·ª•p ·∫£nh l·∫°i.', 'error');
                return;
            }
            
            // Save prompt for later use
            PixelMind.savePrompt(prompt);
            
            // Show loading modal
            showLoading(prompt);
            
            try {
                // Convert base64 to blob
                const response = await fetch(capturedImageData);
                const blob = await response.blob();
                
                // Create form data v·ªõi default optimized settings
                const formData = new FormData();
                formData.append('image', blob, 'captured.jpg');
                formData.append('prompt', prompt);
                formData.append('strength', '0.3'); // Default optimized strength
                
                // Send to backend (s·ª≠ d·ª•ng simple endpoint)
                const result = await fetch(`${PixelMind.API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await result.json();
                
                hideLoading();
                
                if (data.success) {
                    // Store result data and go to result page
                    localStorage.setItem('processResult', JSON.stringify(data));
                    PixelMind.showNotification(`T·∫°o th√†nh c√¥ng ${data.total_images} ·∫£nh!`, 'success');
                    setTimeout(() => {
                        window.location.href = 'result.html';
                    }, 1000);
                } else {
                    PixelMind.showNotification('L·ªói x·ª≠ l√Ω ·∫£nh: ' + data.error, 'error');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error processing image:', error);
                PixelMind.showNotification('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        }
        
        function showLoading(prompt) {
            document.getElementById('loadingModal').style.display = 'flex';
            
            // Show enhanced prompt info
            const enhancedInfo = document.getElementById('enhancedPromptDisplay');
            enhancedInfo.innerHTML = `<strong>M√¥ t·∫£ g·ªëc:</strong> "${prompt}"`;
            
            // Simulate progress
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const interval = setInterval(() => {
                progress += Math.random() * 3 + 1;
                if (progress > 95) progress = 95;
                
                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
            }, 1000);
            
            // Store interval to clear later
            window.loadingInterval = interval;
        }
        
        function hideLoading() {
            document.getElementById('loadingModal').style.display = 'none';
            if (window.loadingInterval) {
                clearInterval(window.loadingInterval);
            }
        }
    </script>
</body>
</html>
